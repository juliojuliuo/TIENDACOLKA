<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inversiones COLKA | Tienda de Tecnolog√≠a</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #050505; color: white; font-family: sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        .animate-pop { animation: pop 0.3s ease-in-out; }
        html { scroll-behavior: smooth; }
        
        /* Efecto de imagen para productos agotados */
        .agotado-img { filter: grayscale(100%) opacity(60%); }
    </style>
</head>
<body>

    <nav class="p-4 md:p-6 border-b border-zinc-900 flex justify-between items-center sticky top-0 bg-black/90 z-40 backdrop-blur-md">
        <div onclick="filtrar('Todos')" class="cursor-pointer group">
            <h1 class="text-xl md:text-2xl font-black italic uppercase tracking-tighter leading-none text-white">
                Inversiones <span class="text-blue-500 md:text-3xl transition-all group-hover:text-blue-400">COLKA</span>
            </h1>
            <p class="text-[9px] text-zinc-400 font-bold uppercase tracking-widest pl-1">Tecnolog√≠a & Stock Real</p>
        </div>
        <div class="flex gap-3 items-center">
            <button onclick="abrirCarrito()" class="relative bg-zinc-900 p-2 md:px-4 md:py-2 rounded-xl text-[10px] font-bold uppercase border border-zinc-800 hover:bg-zinc-800 transition-all flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                <span class="hidden md:inline text-white">Mi Compra</span>
                <span id="badge-carrito" class="absolute -top-2 -right-2 bg-blue-600 text-white text-[10px] font-black w-5 h-5 flex items-center justify-center rounded-full shadow-lg">0</span>
            </button>
            <button onclick="abrirLogin()" id="btn-admin-panel" class="hidden md:block bg-zinc-900 px-4 py-2 rounded-xl text-[10px] font-bold uppercase border border-zinc-800 hover:bg-zinc-800 transition-all">Admin</button>
        </div>
    </nav>

    <div class="relative w-full max-w-6xl mx-auto px-6 pt-12 pb-8 mt-4">
        <div class="absolute inset-0 bg-blue-600/20 blur-[100px] rounded-full z-0"></div>
        <div class="relative z-10 glass border-blue-500/30 p-8 md:p-16 rounded-[3rem] text-center overflow-hidden shadow-2xl">
            <div class="absolute -top-24 -right-24 w-64 h-64 bg-blue-500/30 blur-3xl rounded-full"></div>
            <h2 class="text-5xl md:text-7xl font-black italic uppercase tracking-tighter mb-6 relative z-10 text-white drop-shadow-lg">
                La mejor <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-blue-600">Tecnolog√≠a</span> <br class="hidden md:block">en Colcabamba
            </h2>
            <p class="text-zinc-300 text-sm md:text-lg max-w-2xl mx-auto relative z-10 font-medium leading-relaxed">
                M√°s de 2 a√±os tray√©ndote los mejores equipos celulares, repuestos y accesorios. ¬°Stock real, entrega inmediata y garant√≠a asegurada en nuestra tienda!
            </p>
            <div class="mt-8 flex justify-center gap-4 relative z-10">
                <a href="#buscador-section" class="bg-blue-600 text-white px-8 py-4 rounded-2xl font-black uppercase text-xs hover:bg-blue-500 transition-all shadow-[0_0_20px_rgba(37,99,235,0.4)]">Ver Cat√°logo</a>
            </div>
        </div>
    </div>

    <section id="seccion-destacados" class="max-w-6xl mx-auto px-6 pt-12 hidden">
        <h3 class="text-2xl font-black italic uppercase text-white mb-6 flex items-center gap-2 border-b border-zinc-800 pb-4">
            <span class="text-3xl">üî•</span> Top Inversiones Colka
        </h3>
        <div id="contenedor-destacados" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            </div>
    </section>

    <div class="pt-16 px-6 max-w-4xl mx-auto" id="buscador-section">
        <h3 class="text-xl font-black italic uppercase text-center text-zinc-500 mb-4">Cat√°logo Completo</h3>
        <div class="relative shadow-lg">
            <input type="text" id="buscador" oninput="buscarProducto()" 
                   placeholder="Buscar productos, marcas o caracter√≠sticas..." 
                   class="w-full bg-zinc-900 border border-zinc-800 p-4 pl-12 rounded-xl text-sm text-white outline-none focus:border-blue-500 transition-all focus:shadow-[0_0_15px_rgba(37,99,235,0.2)]">
            <div class="absolute left-4 top-4 text-zinc-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
            </div>
        </div>
    </div>

    <div id="contenedor-filtros" class="flex gap-2 overflow-x-auto p-6 no-scrollbar justify-start md:justify-center bg-transparent mt-2">
        </div>

    <div id="panel-admin" class="hidden p-6 max-w-4xl mx-auto">
        <div class="glass p-8 rounded-[2.5rem] border-blue-500/50 relative">
            <h3 id="admin-titulo" class="text-xl font-bold mb-6 text-blue-500 italic uppercase">AGREGAR NUEVO PRODUCTO</h3>
            <input type="hidden" id="edit-id">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-black">
                <input id="p-nombre" placeholder="Nombre del Equipo (Ej: Samsung Galaxy A54)" class="p-4 rounded-xl text-sm outline-none w-full border border-transparent focus:border-blue-500">
                <input id="p-precio" placeholder="Precio (S/)" type="number" class="p-4 rounded-xl text-sm outline-none w-full border border-transparent focus:border-blue-500">
                
                <input id="p-cat" list="sugerencias-cat" placeholder="Categor√≠a (Ej: Celulares, Fundas...)" class="p-4 rounded-xl text-sm outline-none w-full border border-transparent focus:border-blue-500">
                <datalist id="sugerencias-cat">
                    <option value="Celulares">
                    <option value="Cargadores">
                    <option value="Aud√≠fonos">
                    <option value="Accesorios">
                    <option value="Parlantes">
                </datalist>

                <select id="p-etiqueta" class="p-4 rounded-xl text-sm outline-none w-full border border-transparent focus:border-blue-500 text-zinc-600 font-bold">
                    <option value="">Normal (Sin etiqueta)</option>
                    <option value="Oferta">üî• EN OFERTA</option>
                    <option value="Destacado">‚≠ê DESTACADO</option>
                    <option value="M√°s Vendido">üèÜ M√ÅS VENDIDO</option>
                </select>

                <input id="p-stock" placeholder="Stock disponible (Pon 0 para Agotado)" type="number" class="p-4 rounded-xl text-sm outline-none w-full border border-transparent focus:border-blue-500">
                <input id="p-imagen" placeholder="URL directa de la foto (.jpg o .png)" class="p-4 rounded-xl text-sm outline-none w-full border border-transparent focus:border-blue-500">
                
                <textarea id="p-desc" placeholder="Descripci√≥n detallada y caracter√≠sticas completas del producto..." class="md:col-span-2 p-4 rounded-xl text-sm outline-none w-full h-32 resize-none border border-transparent focus:border-blue-500"></textarea>
                
                <button onclick="guardarProducto()" class="md:col-span-2 bg-blue-600 text-white py-4 rounded-xl font-black uppercase text-xs hover:bg-blue-500 transition-all">Guardar Cambios</button>
                
                <div class="md:col-span-2 flex gap-4 mt-2">
                    <button onclick="cerrarAdmin()" class="flex-1 bg-zinc-800 text-white py-3 rounded-xl text-[10px] font-bold uppercase hover:bg-zinc-700 transition-all">Ocultar Panel</button>
                    <button onclick="salirAdmin()" class="flex-1 bg-red-600 text-white py-3 rounded-xl text-[10px] font-bold uppercase hover:bg-red-700 transition-all">Cerrar Sesi√≥n Admin</button>
                </div>
            </div>
        </div>
    </div>

    <main id="contenedor-productos" class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-6xl mx-auto">
        <p class="col-span-full text-center text-zinc-600">Cargando cat√°logo...</p>
    </main>

    <footer class="p-8 bg-zinc-950 border-t border-zinc-900 mt-16">
        <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-8 text-center md:text-left text-zinc-400 text-sm">
            <div>
                <h4 class="text-white font-black italic uppercase mb-4 text-lg">Inversiones <span class="text-blue-500">COLKA</span></h4>
                <p>Tu mejor opci√≥n en tecnolog√≠a. Venta de celulares, repuestos y accesorios en general.</p>
                <button onclick="abrirLogin()" class="mt-4 bg-zinc-900 px-4 py-2 rounded-xl text-[10px] font-bold uppercase border border-zinc-800 text-white hover:bg-zinc-800 transition-all shadow-lg">Acceso Admin</button>
            </div>
            <div>
                <h4 class="text-white font-bold mb-4 uppercase text-xs tracking-widest">Vis√≠tanos</h4>
                <p>Distrito de Colcabamba</p>
                <p>1er Piso, Hotel Del Pino</p>
            </div>
            <div>
                <h4 class="text-white font-bold mb-4 uppercase text-xs tracking-widest">Contacto Directo</h4>
                <p>WhatsApp: +51 983 200 830</p>
            </div>
        </div>
        <p class="text-center mt-12 text-[10px] text-zinc-600 uppercase tracking-widest">¬© 2026 Inversiones COLKA. Todos los derechos reservados.</p>
    </footer>

    <div id="modal-producto" class="fixed inset-0 bg-black/95 hidden z-[110] flex items-center justify-center p-4 backdrop-blur-md transition-all">
        <div class="glass max-w-4xl w-full rounded-[2rem] border-zinc-800 overflow-hidden relative flex flex-col md:flex-row max-h-[90vh]">
            <button onclick="cerrarProducto()" class="absolute top-4 right-4 bg-black/50 text-white w-8 h-8 rounded-full flex items-center justify-center font-black hover:bg-red-600 z-50 transition-all border border-zinc-700">‚úï</button>
            <div class="w-full md:w-1/2 bg-zinc-950 min-h-[300px] relative flex items-center justify-center p-6 border-b md:border-b-0 md:border-r border-zinc-800">
                <img id="detalle-img" src="" class="max-w-full max-h-[400px] object-contain rounded-xl drop-shadow-2xl">
            </div>
            <div class="w-full md:w-1/2 p-6 md:p-10 flex flex-col justify-between bg-black overflow-y-auto no-scrollbar">
                <div>
                    <span id="detalle-cat" class="text-[10px] font-black text-blue-500 uppercase tracking-widest block mb-2"></span>
                    <h3 id="detalle-nombre" class="text-2xl md:text-3xl font-black italic uppercase leading-tight mb-6 text-white"></h3>
                    <div class="mb-8">
                        <h4 class="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-3 border-b border-zinc-800 pb-2">Caracter√≠sticas y Descripci√≥n</h4>
                        <p id="detalle-desc" class="text-sm text-zinc-300 whitespace-pre-wrap leading-relaxed"></p>
                    </div>
                </div>
                <div class="mt-4">
                    <p class="text-4xl font-black text-white mb-6">S/ <span id="detalle-precio"></span></p>
                    <div class="bg-zinc-900 p-4 rounded-xl mb-4 flex justify-between items-center border border-zinc-800">
                        <span class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest">Stock Disponible</span>
                        <span id="detalle-stock" class="font-black text-sm text-white"></span>
                    </div>
                    <button id="btn-detalle-carrito" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black uppercase text-xs hover:bg-blue-500 transition-all flex justify-center items-center gap-2 shadow-[0_0_20px_rgba(37,99,235,0.4)]">
                        A√±adir al Carrito
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-carrito" class="fixed inset-0 bg-black/95 hidden z-[100] flex justify-end transition-all backdrop-blur-sm">
        <div class="w-full md:w-[450px] bg-zinc-950 h-full flex flex-col border-l border-zinc-900 shadow-2xl">
            <div class="p-6 border-b border-zinc-900 flex justify-between items-center bg-black">
                <h3 class="text-xl font-black italic text-white uppercase flex items-center gap-2">Tu Pedido</h3>
                <button onclick="cerrarCarrito()" class="text-zinc-500 hover:text-white font-black text-2xl transition-all">‚úï</button>
            </div>
            <div id="items-carrito" class="flex-1 overflow-y-auto p-6 flex flex-col gap-4 no-scrollbar"></div>
            <div class="p-6 bg-black border-t border-zinc-900 shadow-[0_-10px_30px_rgba(0,0,0,0.5)]">
                <div class="flex justify-between items-center mb-6">
                    <span class="text-sm font-bold text-zinc-500 uppercase">Total a Pagar</span>
                    <span class="text-3xl font-black text-blue-500">S/ <span id="total-carrito">0.00</span></span>
                </div>
                <button onclick="enviarPedidoWhatsApp()" class="w-full bg-green-600 text-white py-4 rounded-xl font-black uppercase text-xs hover:bg-green-500 transition-all flex justify-center items-center gap-2">Pedir por WhatsApp</button>
            </div>
        </div>
    </div>

    <div id="modal-login" class="fixed inset-0 bg-black/95 hidden z-[110] flex items-center justify-center p-6 text-center backdrop-blur-sm">
        <div class="glass p-8 rounded-3xl w-full max-w-sm border-blue-500/30">
            <h3 class="text-xl font-bold mb-6 italic text-white uppercase tracking-widest">ACCESO STAFF</h3>
            <input type="password" id="pass-admin" placeholder="Contrase√±a" class="w-full bg-black border border-zinc-800 p-4 rounded-xl mb-4 text-center text-white outline-none focus:border-blue-500 transition-all">
            <button onclick="validarAcceso()" class="w-full bg-blue-600 py-4 rounded-xl font-black uppercase text-xs text-white hover:bg-blue-500 transition-all">Ingresar</button>
            <button onclick="cerrarLogin()" class="mt-4 text-zinc-500 text-[10px] uppercase hover:text-white transition-all tracking-widest">Cancelar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBcOlkenlK-ATzMg7LG12kukr7l1gPJZfY",
            authDomain: "inversiones-colka.firebaseapp.com",
            projectId: "inversiones-colka",
            storageBucket: "inversiones-colka.firebasestorage.app",
            messagingSenderId: "760185289386",
            appId: "1:760185289386:web:b7f0b49334b04efd40aed3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let productosData = [];
        let categoriaFiltro = "Todos";
        let textoBusqueda = "";
        let esAdmin = false; 
        let carrito = [];

        // --- CARRITO ---
        window.abrirCarrito = () => document.getElementById('modal-carrito').classList.remove('hidden');
        window.cerrarCarrito = () => document.getElementById('modal-carrito').classList.add('hidden');

        window.agregarAlCarrito = (id) => {
            const producto = productosData.find(p => p.id === id);
            const stockActual = producto.stock || 0;
            if(stockActual <= 0) return alert("Lo sentimos, este producto est√° agotado.");
            const itemExistente = carrito.find(item => item.id === id);
            if(itemExistente) {
                if(itemExistente.cantidad < stockActual) { itemExistente.cantidad++; } 
                else { return alert("No hay m√°s unidades en stock."); }
            } else { carrito.push({ ...producto, cantidad: 1 }); }
            actualizarInterfazCarrito();
            const badge = document.getElementById('badge-carrito');
            badge.classList.remove('animate-pop'); void badge.offsetWidth; badge.classList.add('animate-pop');
        };

        window.quitarDelCarrito = (id) => { carrito = carrito.filter(item => item.id !== id); actualizarInterfazCarrito(); };

        window.modificarCantidad = (id, cambio) => {
            const item = carrito.find(i => i.id === id);
            const productoOriginal = productosData.find(p => p.id === id);
            if(item) {
                const nuevaCantidad = item.cantidad + cambio;
                if(nuevaCantidad > 0 && nuevaCantidad <= (productoOriginal.stock || 0)) { item.cantidad = nuevaCantidad; } 
                else if (nuevaCantidad <= 0) { quitarDelCarrito(id); }
            }
            actualizarInterfazCarrito();
        };

        function actualizarInterfazCarrito() {
            const contenedor = document.getElementById('items-carrito');
            const totalElemento = document.getElementById('total-carrito');
            const badge = document.getElementById('badge-carrito');
            contenedor.innerHTML = '';
            let total = 0, totalItems = 0;
            if(carrito.length === 0) {
                contenedor.innerHTML = `<p class="text-center text-zinc-600 mt-20 text-sm font-bold uppercase">Tu carrito est√° vac√≠o</p>`;
            } else {
                carrito.forEach(item => {
                    total += (item.precio * item.cantidad); totalItems += item.cantidad;
                    contenedor.innerHTML += `
                        <div class="flex items-center gap-4 bg-zinc-900 p-4 rounded-2xl border border-zinc-800 relative">
                            <img src="${item.imagen || "https://via.placeholder.com/300"}" class="w-16 h-16 object-cover rounded-xl bg-black">
                            <div class="flex-1">
                                <h4 class="text-sm font-bold text-white mb-1">${item.nombre}</h4>
                                <p class="text-blue-500 font-black text-sm">S/ ${item.precio}</p>
                            </div>
                            <div class="flex items-center gap-2 bg-black px-2 py-1 rounded-lg border border-zinc-800">
                                <button onclick="modificarCantidad('${item.id}', -1)" class="text-zinc-500 hover:text-white px-2 font-black">-</button>
                                <span class="text-white font-bold text-xs">${item.cantidad}</span>
                                <button onclick="modificarCantidad('${item.id}', 1)" class="text-zinc-500 hover:text-white px-2 font-black">+</button>
                            </div>
                            <button onclick="quitarDelCarrito('${item.id}')" class="absolute -top-2 -right-2 bg-red-600 text-white w-6 h-6 rounded-full text-[10px] font-black hover:bg-red-700 shadow-lg">X</button>
                        </div>`;
                });
            }
            totalElemento.innerText = total.toFixed(2); badge.innerText = totalItems;
        }

        window.enviarPedidoWhatsApp = () => {
            if(carrito.length === 0) return alert("Agrega productos al carrito primero.");
            const nombreCliente = prompt("Escribe tu nombre para registrar el pedido:");
            if(!nombreCliente) return;

            let mensaje = `*NUEVO PEDIDO WEB - INVERSIONES COLKA*%0Aüë§ *Cliente:* ${nombreCliente}%0A--------------------------------%0A`;
            let total = 0;
            carrito.forEach(item => {
                let subtotal = item.precio * item.cantidad;
                mensaje += `‚ñ™Ô∏è ${item.cantidad}x ${item.nombre} (S/ ${subtotal.toFixed(2)})%0A`;
                total += subtotal;
            });
            mensaje += `--------------------------------%0A*üí∞ TOTAL A PAGAR: S/ ${total.toFixed(2)}*%0A%0Aüìç _Deseo coordinar la entrega y el pago._`;
            window.open(`https://wa.me/51983200830?text=${mensaje}`);
        };

        // --- VISTA DETALLE ---
        window.abrirProducto = (id) => {
            const p = productosData.find(x => x.id === id);
            if(!p) return;
            const stockVal = p.stock || 0;
            
            document.getElementById('detalle-img').src = p.imagen || "https://via.placeholder.com/600";
            document.getElementById('detalle-cat').innerText = p.categoria || "Otros";
            document.getElementById('detalle-nombre').innerText = p.nombre;
            document.getElementById('detalle-desc').innerText = p.descripcion || "Sin descripci√≥n.";
            document.getElementById('detalle-precio').innerText = p.precio;
            
            const stockEl = document.getElementById('detalle-stock');
            const btnCarrito = document.getElementById('btn-detalle-carrito');

            if(stockVal <= 0) {
                stockEl.innerText = "AGOTADO";
                stockEl.className = 'font-black text-sm text-red-500';
                btnCarrito.innerText = "Producto Agotado";
                btnCarrito.className = "w-full bg-zinc-800 text-zinc-500 py-4 rounded-2xl font-black uppercase text-xs cursor-not-allowed";
                btnCarrito.onclick = null;
            } else {
                stockEl.innerText = stockVal + " Und.";
                stockEl.className = 'font-black text-sm text-green-400';
                btnCarrito.innerText = "A√±adir al Carrito";
                btnCarrito.className = "w-full bg-blue-600 text-white py-4 rounded-2xl font-black uppercase text-xs hover:bg-blue-500 transition-all flex justify-center items-center gap-2 shadow-[0_0_20px_rgba(37,99,235,0.4)]";
                btnCarrito.onclick = () => { agregarAlCarrito(p.id); cerrarProducto(); };
            }
            document.getElementById('modal-producto').classList.remove('hidden');
        };
        window.cerrarProducto = () => document.getElementById('modal-producto').classList.add('hidden');

        // --- ADMIN ---
        window.validarAcceso = () => {
            if(document.getElementById('pass-admin').value === "hola123") {
                esAdmin = true; document.getElementById('modal-login').classList.add('hidden');
                document.getElementById('panel-admin').classList.remove('hidden');
                document.getElementById('pass-admin').value = ""; render();
            } else { alert("Clave Incorrecta"); }
        };
        window.cerrarAdmin = () => document.getElementById('panel-admin').classList.add('hidden');
        window.salirAdmin = () => { esAdmin = false; cerrarAdmin(); render(); alert("Sesi√≥n cerrada."); };

        window.guardarProducto = async () => {
            const id = document.getElementById('edit-id').value;
            const nombre = document.getElementById('p-nombre').value;
            const precio = document.getElementById('p-precio').value;
            const cat = document.getElementById('p-cat').value || "Otros"; 
            const etiqueta = document.getElementById('p-etiqueta').value; // Nueva etiqueta
            const stock = document.getElementById('p-stock').value;
            const imagen = document.getElementById('p-imagen').value;
            const desc = document.getElementById('p-desc').value;

            if(!nombre || !precio || !stock) return alert("Nombre, Precio y Stock son obligatorios");

            const data = {
                nombre: nombre, precio: parseFloat(precio),
                categoria: cat.charAt(0).toUpperCase() + cat.slice(1).toLowerCase(), 
                etiqueta: etiqueta, stock: parseInt(stock),
                imagen: imagen || "", descripcion: desc || "", timestamp: Date.now()
            };

            try {
                if(id) { await updateDoc(doc(db, "productos", id), data); alert("‚úÖ Modificado"); } 
                else { await addDoc(collection(db, "productos"), data); alert("üöÄ Agregado"); }
                limpiarForm();
            } catch (e) { alert("Error: " + e.message); }
        };

        window.prepararEdicion = (id) => {
            const p = productosData.find(x => x.id === id);
            document.getElementById('edit-id').value = p.id;
            document.getElementById('p-nombre').value = p.nombre || '';
            document.getElementById('p-precio').value = p.precio || '';
            document.getElementById('p-cat').value = p.categoria || '';
            document.getElementById('p-etiqueta').value = p.etiqueta || ''; // Carga etiqueta
            document.getElementById('p-stock').value = p.stock || 0;
            document.getElementById('p-imagen').value = p.imagen || "";
            document.getElementById('p-desc').value = p.descripcion || "";
            document.getElementById('admin-titulo').innerText = "EDITANDO: " + p.nombre;
            document.getElementById('panel-admin').classList.remove('hidden'); window.scrollTo(0,0);
        };

        window.eliminarProd = async (id) => { if(confirm("¬øBorrar producto?")) await deleteDoc(doc(db, "productos", id)); };

        function limpiarForm() {
            document.getElementById('edit-id').value = ''; document.getElementById('p-nombre').value = '';
            document.getElementById('p-precio').value = ''; document.getElementById('p-cat').value = '';
            document.getElementById('p-etiqueta').value = ''; document.getElementById('p-stock').value = '';
            document.getElementById('p-imagen').value = ''; document.getElementById('p-desc').value = '';
            document.getElementById('admin-titulo').innerText = "AGREGAR NUEVO PRODUCTO";
        }

        // --- RENDERIZADO Y HTML ---
        function renderFiltros() {
            const cont = document.getElementById('contenedor-filtros');
            const categoriasUnicas = ["Todos", ...new Set(productosData.map(p => p.categoria || "Otros"))];
            cont.innerHTML = '';
            categoriasUnicas.forEach(cat => {
                const isSelected = cat === categoriaFiltro;
                const claseBase = "px-6 py-2 shrink-0 rounded-full text-[10px] font-black uppercase transition-all shadow-lg cursor-pointer ";
                const claseActiva = isSelected ? "bg-blue-600 text-white" : "bg-zinc-900 text-zinc-500 hover:text-white";
                cont.innerHTML += `<button onclick="filtrar('${cat}')" class="${claseBase} ${claseActiva}">${cat}</button>`;
            });
        }

        window.filtrar = (cat) => { categoriaFiltro = cat; renderFiltros(); render(); };
        window.buscarProducto = () => { textoBusqueda = document.getElementById('buscador').value.toLowerCase(); render(); };

        // Funci√≥n para crear la tarjeta HTML de un producto
        function generarHTMLProducto(p) {
            const stockVal = p.stock || 0;
            const esAgotado = stockVal <= 0;
            const catName = p.categoria || "Otros";
            const imgPlaceholder = p.imagen || "https://via.placeholder.com/300";
            
            // Generador de Etiquetas Visuales
            let htmlEtiqueta = '';
            if (p.etiqueta === 'Oferta') htmlEtiqueta = `<span class="absolute top-4 left-4 z-20 bg-gradient-to-r from-red-600 to-pink-600 text-white text-[10px] font-black uppercase px-4 py-1.5 rounded-full shadow-lg border border-red-400">üî• Oferta</span>`;
            else if (p.etiqueta === 'Destacado') htmlEtiqueta = `<span class="absolute top-4 left-4 z-20 bg-gradient-to-r from-yellow-500 to-amber-500 text-black text-[10px] font-black uppercase px-4 py-1.5 rounded-full shadow-lg border border-yellow-300">‚≠ê Destacado</span>`;
            else if (p.etiqueta === 'M√°s Vendido') htmlEtiqueta = `<span class="absolute top-4 left-4 z-20 bg-gradient-to-r from-orange-500 to-red-500 text-white text-[10px] font-black uppercase px-4 py-1.5 rounded-full shadow-lg border border-orange-300">üèÜ M√°s Vendido</span>`;

            // Efectos de Agotado
            const imgClass = esAgotado ? 'agotado-img w-full h-48 object-cover transition-all' : 'w-full h-48 object-cover hover:scale-105 transition-all duration-500';
            const selloAgotado = esAgotado ? `<div class="absolute inset-0 bg-black/40 z-10 flex items-center justify-center rounded-[1.5rem]"><span class="bg-zinc-950/80 text-white border-2 border-red-600 font-black text-xl px-6 py-2 rounded-xl rotate-[-15deg] tracking-widest backdrop-blur-sm">AGOTADO</span></div>` : '';
            
            const btnCarritoHTML = esAgotado 
                ? `<button disabled class="w-full bg-zinc-800 text-zinc-500 py-4 rounded-2xl font-black uppercase text-[10px] cursor-not-allowed">Agotado</button>`
                : `<button onclick="agregarAlCarrito('${p.id}')" class="w-full bg-white text-black py-4 rounded-2xl font-black uppercase text-[10px] hover:bg-blue-600 hover:text-white transition-all shadow-lg">A√±adir al Carrito</button>`;

            return `
                <div class="glass p-6 rounded-[2.5rem] relative group border-zinc-800 hover:border-blue-500/50 hover:shadow-[0_0_30px_rgba(37,99,235,0.15)] transition-all flex flex-col justify-between hover:-translate-y-1 duration-300">
                    ${htmlEtiqueta}
                    
                    <div class="cursor-pointer" onclick="abrirProducto('${p.id}')">
                        <div class="overflow-hidden rounded-[1.5rem] mb-4 bg-zinc-900 relative">
                            ${selloAgotado}
                            <img src="${imgPlaceholder}" class="${imgClass}" alt="${p.nombre}">
                            ${!esAgotado ? `<div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-all flex items-center justify-center z-10"><span class="text-white text-xs font-bold uppercase border border-white/50 px-4 py-2 rounded-full backdrop-blur-sm">Ver Detalle</span></div>` : ''}
                        </div>
                        <span class="text-[9px] font-black ${esAgotado ? 'text-zinc-600' : 'text-blue-500'} uppercase tracking-widest block mb-2">${catName}</span>
                        <h3 class="text-xl font-black italic uppercase leading-tight mb-2 ${esAgotado ? 'text-zinc-500' : 'text-white'} group-hover:text-blue-400 transition-all">${p.nombre}</h3>
                        <p class="text-3xl font-black ${esAgotado ? 'text-zinc-600' : 'text-white'} mb-6">S/ ${p.precio}</p>
                    </div>
                    
                    <div>
                        <div class="bg-zinc-900/80 p-3 rounded-xl mb-4 flex justify-between items-center border border-zinc-800">
                            <span class="text-[9px] font-bold text-zinc-500 uppercase tracking-widest">Stock Disponible</span>
                            <span class="font-black text-sm ${esAgotado ? 'text-red-600' : 'text-green-400'}">${stockVal} Und.</span>
                        </div>
                        
                        ${btnCarritoHTML}

                        ${esAdmin ? `
                            <div class="flex gap-2 mt-4 relative z-20">
                                <button onclick="prepararEdicion('${p.id}')" class="flex-1 bg-zinc-800 border border-zinc-700 text-blue-400 py-3 rounded-xl text-[9px] font-bold uppercase hover:bg-blue-900/30 transition-all">Editar</button>
                                <button onclick="eliminarProd('${p.id}')" class="flex-1 bg-zinc-800 border border-zinc-700 text-red-500 py-3 rounded-xl text-[9px] font-bold uppercase hover:bg-red-900/30 transition-all">Borrar</button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function render() {
            // 1. Renderizar Destacados/Ofertas (Ignora los filtros de categor√≠a/b√∫squeda para que siempre se vean)
            const contDestacados = document.getElementById('contenedor-destacados');
            const seccionDestacados = document.getElementById('seccion-destacados');
            const prodsDestacados = productosData.filter(p => p.etiqueta && p.etiqueta !== "" && (p.stock || 0) > 0);
            
            if(prodsDestacados.length > 0 && textoBusqueda === "" && categoriaFiltro === "Todos") {
                seccionDestacados.classList.remove('hidden');
                contDestacados.innerHTML = prodsDestacados.map(p => generarHTMLProducto(p)).join('');
            } else {
                seccionDestacados.classList.add('hidden');
            }

            // 2. Renderizar Cat√°logo General
            const cont = document.getElementById('contenedor-productos');
            const filtrados = productosData.filter(p => {
                const cat = p.categoria || "Otros";
                const coincideCategoria = (categoriaFiltro === "Todos" || cat === categoriaFiltro);
                const nombre = (p.nombre || "").toLowerCase();
                const desc = (p.descripcion || "").toLowerCase();
                const coincideNombre = nombre.includes(textoBusqueda) || desc.includes(textoBusqueda);
                return coincideCategoria && coincideNombre;
            }).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
            
            if(filtrados.length === 0) {
                cont.innerHTML = `<p class="col-span-full text-center text-zinc-600 py-10 font-bold tracking-widest uppercase">No hay productos aqu√≠.</p>`;
            } else {
                cont.innerHTML = filtrados.map(p => generarHTMLProducto(p)).join('');
            }
        }

        // --- INICIO ---
        onSnapshot(collection(db, "productos"), (snap) => {
            productosData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderFiltros(); render(); actualizarInterfazCarrito();
        });
        window.abrirLogin = () => document.getElementById('modal-login').classList.remove('hidden');
        window.cerrarLogin = () => document.getElementById('modal-login').classList.add('hidden');
    </script>
</body>
</html>
